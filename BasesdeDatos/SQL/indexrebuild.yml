- hosts: all

  vars:
    - user: usuario
    - sqlserver_instance: localhost
    - sqlserver_username: sa
    - sqlserver_password: pass
    - database_name: dbTesting
    - database_filepath: C:\sqldb
    - du_percent: 80
    - pages_count: 100

  tasks:
    - name: Execute Command
      win_command: sqlcmd -S {{ sqlserver_instance }} -U {{ sqlserver_username }} -P {{ sqlserver_password }} -q "DECLARE @LocalDbList TABLE([DatabaseName] NVARCHAR(MAX), [DatabaseId] INT, [CreateDate] DATETIME, [RebuildingComplete] BIT); DECLARE @SqlCommand NVARCHAR(MAX),  @SqlParameters NVARCHAR(MAX); DECLARE @DbInProgress NVARCHAR(MAX); DECLARE @DUPercent INT={{ du_percent }}, @PagesCount INT={{ pages_count }}; DECLARE  @IXRebuildingList TABLE([DatabaseName] NVARCHAR(MAX), [SchemaName] NVARCHAR(MAX), [TableName] NVARCHAR(MAX), [IndexName] NVARCHAR(MAX), [type_desc] NVARCHAR(MAX), [is_unique] BIT, [fill_factor] TINYINT, [partition_number] INT, [index_type_desc] NVARCHAR(MAX), [alloc_unit_type_desc] NVARCHAR(MAX), [index_depth] TINYINT, [index_level] TINYINT, [avg_fragmentation_in_percent] FLOAT, [page_count] BIGINT, [Rebuilding] BIT); DECLARE @msgAll TABLE([msgStart] NVARCHAR(MAX), [msgFinish] NVARCHAR(MAX), [datetimeStart] DATETIME, [datetimeFinish] DATETIME); DECLARE @sqlquery NVARCHAR(MAX), @parameters NVARCHAR(MAX), @dbName NVARCHAR(MAX), @scName NVARCHAR(MAX),  @tbName NVARCHAR(MAX), @ixName NVARCHAR(MAX), @msgUnt1 NVARCHAR(MAX), @msgUnt2 NVARCHAR(MAX), @dtStart DATETIME, @dtFinish DATETIME; INSERT INTO @LocalDbList([DatabaseName], [DatabaseId], [CreateDate], [RebuildingComplete]) SELECT [name], [database_id],  [create_date], 0 FROM [sys].[databases] WHERE [name] NOT IN ('master', 'tempdb', 'model', 'msdb') AND [name]='{{ database_name }}'; WHILE EXISTS  (SELECT [DatabaseName] FROM @LocalDbList WHERE [RebuildingComplete]=0)BEGIN DECLARE @IXRebuilding INT=0; SET @DbInProgress=(SELECT TOP 1 [DatabaseName] FROM @LocalDbList WHERE [RebuildingComplete]=0); SET @SqlParameters=N'@DUPercentIN INT, @PagesCountIN INT'; SET  @SqlCommand=N'USE ['+@DbInProgress+N']; DECLARE @DUPercent INT=30, @PagesCount INT=100; DECLARE @IXRebuildingList TABLE([DatabaseName]  NVARCHAR(MAX),[SchemaName] NVARCHAR(MAX),[TableName] NVARCHAR(MAX),[IndexName] NVARCHAR(MAX),[type_desc] NVARCHAR (MAX),[is_unique] BIT, [fill_factor] TINYINT,[partition_number] INT,[index_type_desc] NVARCHAR(MAX),[alloc_unit_type_desc] NVARCHAR (MAX),[index_depth] TINYINT,[index_level] TINYINT,[avg_fragmentation_in_percent] FLOAT, [page_count] BIGINT,[Rebuilding] BIT); IF  @DUPercentIN > 0 SET @DUPercent = @DUPercentIN; IF @PagesCountIN > 0 SET @PagesCount = @PagesCountIN; INSERT INTO @IXRebuildingList ([DatabaseName], [SchemaName], [TableName], [IndexName], [type_desc], [is_unique], [fill_factor], [partition_number],  [index_type_desc], [alloc_unit_type_desc], [index_depth], [index_level], [avg_fragmentation_in_percent], [page_count], [Rebuilding]) SELECT [D].[name] [DatabaseName], [S].[name] [SchemaName], [O].[name] [TableName], [I].[name] [IndexName], [I].[type_desc], [I]. [is_unique], [I].[fill_factor], [DDIPS].[partition_number], [DDIPS].[index_type_desc], [DDIPS].[alloc_unit_type_desc], [DDIPS]. [index_depth], [DDIPS].[index_level], [DDIPS].[avg_fragmentation_in_percent], [DDIPS].[page_count], 0 FROM sys.indexes AS [I] WITH(NOLOCK) INNER JOIN sys.objects AS [O] WITH(NOLOCK)ON [I].[object_id]=[O].[object_id] INNER JOIN sys.schemas AS [S] WITH(NOLOCK)ON [O].[schema_id]=[S].[schema_id] INNER JOIN sys.dm_db_index_physical_stats(NULL, NULL, NULL, NULL, NULL) AS [DDIPS] ON [I].[object_id]=[DDIPS].[object_id] AND [I].[index_id]=[DDIPS].[index_id] INNER JOIN sys.databases AS [D] WITH(NOLOCK)ON [DDIPS].[database_id]=[D].[database_id] WHERE 1=1 AND [I].[type]<>0 AND [I].[name] NOT LIKE ''%aspnet%'' AND [O].[name]<>''sysdiagrams'' AND [D].[name]='''+@DbInProgress+N''' AND [DDIPS].[avg_fragmentation_in_percent]>@DUPercent AND [DDIPS].[page_count]>@PagesCount;SELECT * FROM @IXRebuildingList;'; INSERT INTO @IXRebuildingList EXEC [sys].[sp_executesql] @SqlCommand, @SqlParameters, @DUPercentIN=@DUPercent, @PagesCountIN=@PagesCount; SELECT @IXRebuilding=COUNT([IndexName])FROM @IXRebuildingList; WHILE EXISTS (SELECT [IRL].[IndexName] FROM @IXRebuildingList AS [IRL] WHERE 1=1 AND [IRL].[Rebuilding]=0)AND @IXRebuilding>0 BEGIN SELECT TOP 1 @dbName=[IRL].[DatabaseName], @scName=[IRL].[SchemaName], @tbName=[IRL].[TableName], @ixName=[IRL].[IndexName] FROM @IXRebuildingList AS [IRL] WHERE 1=1 AND [IRL].[Rebuilding]=0 ORDER BY [IRL].[avg_fragmentation_in_percent] DESC; SET @parameters=N'@msg1OUT NVARCHAR(MAX) OUTPUT, @msg2OUT NVARCHAR(MAX) OUTPUT,  @dtsOUT NVARCHAR(MAX) OUTPUT, @dtfOUT NVARCHAR(MAX) OUTPUT'; SET @sqlquery=N'USE [master]; BEGIN TRY SELECT @msg1OUT = ''Rebuild Index  ['+@ixName+N'] en ['+@dbName+N'].['+@scName+N'].['+@tbName+N'] Started''; SET @dtsOUT =  CONVERT(NVARCHAR,GETDATE(),121); ALTER INDEX ['+@ixName+N'] ON ['+@dbName+N'].['+@scName+N'].['+@tbName+N'] REBUILD WITH (ONLINE = ON, SORT_IN_TEMPDB = ON, FILLFACTOR = 90); SET @dtfOUT = CONVERT(NVARCHAR,GETDATE(),121); SELECT @msg2OUT = ''Rebuild Index ['+@ixName+N'] en ['+@dbName+N'].['+@scName+N'].['+@tbName+N'] Finalized''; END TRY BEGIN CATCH SET @dtfOUT = CONVERT(NVARCHAR,GETDATE(),121); SELECT @msg2OUT = ''Failed Rebuild Index ['+@ixName+N'] en ['+@dbName+N'].['+@scName+N'].['+@tbName+N'] Finishing''; END CATCH;'; BEGIN TRY EXEC [sys].[sp_executesql] @sqlquery, @parameters, @msg1OUT=@msgUnt1 OUTPUT, @msg2OUT=@msgUnt2 OUTPUT, @dtsOUT=@dtStart OUTPUT, @dtfOUT=@dtFinish OUTPUT; END TRY BEGIN CATCH PRINT CONCAT('Error en Ejecucion, ', @sqlquery); END CATCH; INSERT INTO @msgAll([msgStart], [msgFinish], [datetimeStart], [datetimeFinish]) VALUES(@msgUnt1, @msgUnt2, @dtStart, @dtFinish); SET @IXRebuilding=@IXRebuilding-1; UPDATE @IXRebuildingList SET [Rebuilding]=1 WHERE [IndexName]=@ixName; END; UPDATE @LocalDbList SET [RebuildingComplete]=1 WHERE [DatabaseName]=@DbInProgress; END; SELECT [msgStart], [msgFinish], [datetimeStart], [datetimeFinish] FROM @msgAll;"
      register: result_valid
    - debug: var=result_valid.stdout_lines
